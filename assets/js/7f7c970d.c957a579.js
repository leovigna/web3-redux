"use strict";(globalThis.webpackChunk_owlprotocol_web3_redux_docs=globalThis.webpackChunk_owlprotocol_web3_redux_docs||[]).push([[8566],{7522:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>m});var r=a(9901);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),d=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=d(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=d(a),m=n,h=c["".concat(s,".").concat(m)]||c[m]||p[m]||i;return a?r.createElement(h,o(o({ref:t},u),{},{components:a})):r.createElement(h,o({ref:t},u))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,o=new Array(i);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,o[1]=l;for(var d=2;d<i;d++)o[d]=a[d];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}c.displayName="MDXCreateElement"},4285:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var r=a(2875),n=(a(9901),a(7522));const i={sidebar_position:2},o="Architecture",l={unversionedId:"web3-redux-advanced/architecture",id:"web3-redux-advanced/architecture",title:"Architecture",description:"Overview of the overall architecture of the library.",source:"@site/docs/web3-redux-advanced/architecture.md",sourceDirName:"web3-redux-advanced",slug:"/web3-redux-advanced/architecture",permalink:"/web3-redux/docs/web3-redux-advanced/architecture",draft:!1,editUrl:"https://github.com/owlprotocol/web3-redux/tree/master/docusaurus/docs/web3-redux-advanced/architecture.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Persistence",permalink:"/web3-redux/docs/web3-redux-advanced/persistence"},next:{title:"Sync Middleware",permalink:"/web3-redux/docs/web3-redux-advanced/sync_middleware"}},s={},d=[{value:"Related Libraries",id:"related-libraries",level:2},{value:"Data Models",id:"data-models",level:2},{value:"CRUD",id:"crud",level:2},{value:"State",id:"state",level:2},{value:"IndexedDB",id:"indexeddb",level:4},{value:"Redux",id:"redux",level:3},{value:"Actions",id:"actions",level:2},{value:"Reducers",id:"reducers",level:2},{value:"Sagas",id:"sagas",level:2},{value:"Hooks",id:"hooks",level:2}],u={toc:d};function p({components:e,...t}){return(0,n.kt)("wrapper",(0,r.Z)({},u,t,{components:e,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"architecture"},"Architecture"),(0,n.kt)("p",null,"Overview of the overall architecture of the library."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Flowchart.svg",src:a(2905).Z,width:"1161",height:"961"})),(0,n.kt)("h2",{id:"related-libraries"},"Related Libraries"),(0,n.kt)("p",null,'To fully understand the architecture of web3-redux, you might want to get familiar with some of the libraries this "meta-library" is built with:'),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"React")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://reactjs.org/docs/hooks-intro.html"},"React Hooks"))),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Redux")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://redux.js.org/"},"redux")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://redux-saga.js.org/"},"redux-saga")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://redux-orm.github.io/redux-orm/"},"redux-orm")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/reduxjs/reselect"},"reselect"))),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"IndexedDB")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API"},"IndexedDB")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://dexie.org/docs/"},"Dexie.js"))),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Blockchain/Web3")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://web3js.readthedocs.io/en/v1.3.0/"},"web3.js")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/ipfs/js-ipfs/tree/master/docs/core-api"},"js-ipfs"))),(0,n.kt)("h2",{id:"data-models"},"Data Models"),(0,n.kt)("p",null,"We use the concept of a data model to refer to each type of relevant data that is stored by web3-redux and be queried on-chain (EVM) or on decentralized networks (IPFS). The data model defines the interface of the data, but also validation logic, indexing rules, and relevant actions, selectors & hooks to perform CRUD operations on the data collection. Some common data models meant to represet blockchain data include the following:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/web3-redux/docs/web3-redux-reference/interfaces/Block.BlockHeader"},"Block")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/web3-redux/docs/web3-redux-reference/interfaces/Transaction.Transaction-1"},"Transaction")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/web3-redux/docs/web3-redux-reference/interfaces/Contract.Contract-1"},"Contract"))),(0,n.kt)("h2",{id:"crud"},"CRUD"),(0,n.kt)("p",null,"Before going into the different components that write to the state, it's important to understand the various possible CRUD (Create, Read, Update, Delete) operations."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CREATE"),": Add an item. Throws error if item ",(0,n.kt)("strong",{parentName:"li"},"exists"),"."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"UPDATE"),": Update an item merging attributes. Throws error if item does ",(0,n.kt)("strong",{parentName:"li"},"not exists"),"."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"PUT"),": Add an item or overwrite all attributes."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"UPSERT"),": Add an item or merge attributes."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"DELETE"),": Delete an item.")),(0,n.kt)("p",null,"The easiest to use operation is the ",(0,n.kt)("inlineCode",{parentName:"p"},"UPSERT")," operation has it combines the logic of a ",(0,n.kt)("inlineCode",{parentName:"p"},"CREATE")," & ",(0,n.kt)("inlineCode",{parentName:"p"},"UPDATE")," operation. This comes at a slight performance cost however as the logic has to read to the database before determining what to write (no native IndexedDB upsert). When possible, consider using ",(0,n.kt)("inlineCode",{parentName:"p"},"CREATE"),"/",(0,n.kt)("inlineCode",{parentName:"p"},"UPDATE"),"/",(0,n.kt)("inlineCode",{parentName:"p"},"PUT"),".\nAll of these operations have ",(0,n.kt)("strong",{parentName:"p"},"batched")," versions (",(0,n.kt)("inlineCode",{parentName:"p"},"{ACTION}/BATCHED"),") enabling insertion of many items in 1 transaction. ",(0,n.kt)("inlineCode",{parentName:"p"},"CREATE/BATCHED")," for example takes an array of items to write to the database."),(0,n.kt)("h2",{id:"state"},"State"),(0,n.kt)("p",null,"State is stored in 2 distinct ways, persistent and in-memory."),(0,n.kt)("h4",{id:"indexeddb"},"IndexedDB"),(0,n.kt)("p",null,"Persistent state is stored using ",(0,n.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API"},"IndexedDB"),", a modern NoSQL database for the browser supported by Chromium, Mozilla and other mainstream browsers. We used ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/indexeddbshim/indexeddbshim"},"indexeddbshim")," to potentially support older browsers with ",(0,n.kt)("a",{parentName:"p",href:"https://caniuse.com/?search=websql"},"WebSQL")," and to run our NodeJS tests by emulating the IndexedDB APIs in-memory. Data stored in IndexedDB can be indexed using various indices enabling efficient queries and pagination. Data is also persistent across user sessions, enabling the web app to load with data on startup without having to make any API calls.\nMost of our data models such as Block, Transaction, ContractEvent are just stored in IndexedDB but other models also have the concept of instantiated objects such as ",(0,n.kt)("inlineCode",{parentName:"p"},"Web3.eth.Contract")," which is used for querying blockchain data. Due to the limitation that all data stored in IndexedDB must be encodable, we cannot store these objects in IndexedDB and instead opt to use a secondary in-memory redux store to store this data during the user session.\nDue to the low-level complexity of IndexedDB APIs, we use ",(0,n.kt)("a",{parentName:"p",href:"https://dexie.org/"},"Dexie.js")," as an easy to use API wrapper for CRUD operations on IndexedDB.\nFor reading data, we use the Dexie provided ",(0,n.kt)("a",{parentName:"p",href:"https://dexie.org/docs/dexie-react-hooks/useLiveQuery()"},"useLiveQuery")," hook that enables writing a Dexie query that updates when parameters or the databases changes. For simplicity, all data models include abstractions for for common queries:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useGet(id|index)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useGetBulk(ids|indices)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useWhere(filter, {reverse,offset,limit})"))),(0,n.kt)("h3",{id:"redux"},"Redux"),(0,n.kt)("p",null,"We use the Redux store to store models that required an instantiated object during the user session. Such objects while not directly stored in IndexedDB, usually have relevant info stored persistently."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Config: The ",(0,n.kt)("inlineCode",{parentName:"li"},"ipfsUrl")," data stored in IndexedDB enables instantiating the ",(0,n.kt)("inlineCode",{parentName:"li"},"ipfsClient")," object."),(0,n.kt)("li",{parentName:"ul"},"Network: The ",(0,n.kt)("inlineCode",{parentName:"li"},"web3Rpc")," data stored in IndexedDB enables instantiating the ",(0,n.kt)("inlineCode",{parentName:"li"},"web3")," object."),(0,n.kt)("li",{parentName:"ul"},"Contract: The ",(0,n.kt)("inlineCode",{parentName:"li"},"address")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"abi")," data stored in IndexedDB enables instating the ",(0,n.kt)("inlineCode",{parentName:"li"},"web3Contract")," object.")),(0,n.kt)("p",null,"All web3-redux data is stored under the ",(0,n.kt)("inlineCode",{parentName:"p"},"web3Redux")," slice of the store as a normalized json store (State). The overall interface of the state can be found under ",(0,n.kt)("a",{parentName:"p",href:"/web3-redux/docs/web3-redux-reference/interfaces/State"},"State"),". To normalize the redux state, we use ",(0,n.kt)("a",{parentName:"p",href:"https://redux-orm.github.io/redux-orm/"},"redux-orm")," library to define models stored in redux and handle CRUD operations."),(0,n.kt)("p",null,"For reading data, ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/reduxjs/reselect"},"Selectors")," for each ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/redux-orm/redux-orm"},"redux-orm")," model are the preferred way to access the state. Some standard selectors shared by all data models:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"selectByIdSingle(id)"),": Select an single instance."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"selectByIdMany(ids)"),": Select multiple instances."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"selectWhere(filter)"),": Select by equality filter. (for complex queries, we recommend using Dexie to leverage IndexedDB indices)\nSelectors have their hook counterparts, which abstract the need to pass in the state."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectByIdSingle(id)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectByIdMany(ids)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectAll()")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectWhere(filter)"))),(0,n.kt)("h2",{id:"actions"},"Actions"),(0,n.kt)("p",null,"State is mutated by the dispatching of Actions. Actions are ",(0,n.kt)("strong",{parentName:"p"},"synchronously")," processed by ",(0,n.kt)("strong",{parentName:"p"},"reducers")," for updates to the redux state and then ",(0,n.kt)("strong",{parentName:"p"},"asynchronously")," processed by ",(0,n.kt)("strong",{parentName:"p"},"sagas")," for updates to the IndexedDB state as its API is asynchronous. Other actions such as API calls to fetch data are also usually asynchronously processed by sagas. Action creators validate the payload they are given using the ",(0,n.kt)("inlineCode",{parentName:"p"},"validate")," or ",(0,n.kt)("inlineCode",{parentName:"p"},"validateId")," function for a specific data model."),(0,n.kt)("h2",{id:"reducers"},"Reducers"),(0,n.kt)("p",null,"Reducers are used by the redux-orm to update the redux state for all CRUD operations."),(0,n.kt)("h2",{id:"sagas"},"Sagas"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://github.com/redux-saga/redux-saga"},"redux-saga")," is used to manage complex event loops of asynchronous actions. All data models include sagas for Dexie CRUD operations that are asynchronous."),(0,n.kt)("h2",{id:"hooks"},"Hooks"),(0,n.kt)("p",null,"We use the following building blocks of hooks to create easy to use hooks for common operations:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useDispatch"),": Get redux dispatch to send actions."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useLiveQuery"),": Read data from IndexedDB state."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelector"),": Read data from redux state.")),(0,n.kt)("p",null,"All data models include the following hooks:"),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Dexie ",(0,n.kt)("inlineCode",{parentName:"strong"},"useLiveQuery")," Hooks")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useGet(id|index)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useGetBulk(ids|indices)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useWhere(filter, {reverse,offset,limit})"))),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Redux ",(0,n.kt)("inlineCode",{parentName:"strong"},"useSelector")," Hooks")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectByIdSingle(id)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectByIdMany(ids)")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectAll()")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useSelectWhere(filter)"))),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Other Hooks")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"useHydrate(id)"),": Hydrate redux state by reading persistent IndexedDB state & dispatching an ",(0,n.kt)("inlineCode",{parentName:"li"},"UPDATE")," action if item exists in IndexedDB state but ",(0,n.kt)("strong",{parentName:"li"},"not")," in redux state. This is a simple way to make sure that a ",(0,n.kt)("inlineCode",{parentName:"li"},"Contract")," model's ",(0,n.kt)("inlineCode",{parentName:"li"},"web3Contract")," is instantianted.")))}p.isMDXComponent=!0},2905:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/web3-redux-architecture-d2e958122ea63209ea32f4123b8b7ca5.svg"}}]);